<?php// 评论控制器namespace app\api\controller\v1;use app\api\controller\BaseController;use app\api\model\ShopEval as ShopEvalModel;use app\api\model\Shop;use app\lib\exception\ParameterException;use app\api\validate\CommentNew;use think\Db;use think\Exception;class Comment extends BaseController{    //普通用户 添加评论    public function UserAddComment(){        //验证传入值        $validate = new CommentNew();        $validate->goCheck();        $post = $validate->getDataByRule(input('post.'));        // 获取用户信息        $User = $this->getUid();        // 验证评论        $comment = ShopEvalModel::CheckComment($post['order_id']);        $post['user_id'] = $User->user_id;        $post['time'] = time();        // 判断是否评论过        if($comment){            return show(201,'您已评论过该订单！');        }        try{            (new ShopEvalModel())->save($post);            Db::table('sbw_order')->where('order_id',$post['order_id'])->update(['order_status'=>5,'updatetime'=>time()]);            $star = Db::table('sbw_shop_eval')->where('shop_id',$post['shop_id'])->avg('star');            $star = intval($star);            Db::table('sbw_shop')->where('shop_id',$post['shop_id'])->update(['star'=>$star]);        }catch(Exception $e){            return show(201,'评论失败');        }        return show(200,'评论成功');    }    //普通用户 获取自己评论    public function GetUserComment(){        // 获取用户信息        $order_id = input('post.order_id');        // 获取用户地址        $comment = ShopEvalModel::getUserComment($order_id);        if (!$comment){            return show(201,'暂时没有评论');        }        return show(200,'ok',['comment'=>$comment]);    }    //获取我商铺的评论    public function GetMyShopComment(){        // 获取用户信息        $User = $this->getUid();        if($User->user_role!=3){            return show(201,'您不是商家！');        }        $Shop = Shop::getByUserID($User->user_id);        if(!$Shop){            return show(201,'商家不存在！');        }        $comment = ShopEvalModel::getShopComment($Shop['shop_id']);        if(!$comment){            return show(201,'暂无评论');        }        return show(200,'ok',['comment'=>$comment]);    }    //获取某商铺的评论    public function GetOShopComment(){        $shop_id = input("post.shop_id",0,'intval');        //直接获取        $comment = ShopEvalModel::getShopComment($shop_id);        if (!$comment){            return show(201,'暂时没有评论');        }        return show(200,'ok',['comment'=>$comment]);    }}