<?php/** * Created by PhpStorm. * User: THINK * Date: 2018/3/20 * Time: 11:06 */namespace app\api\controller\v1;use app\api\controller\BaseController;use app\api\model\Product;use app\api\model\ReportLog;use app\api\model\Shoperinfo;use app\api\model\User;use app\api\service\AccessToken;use app\api\service\DeliveryMessage;use app\api\service\ShoperMessage;use think\Cache;use think\Controller;use think\Db;use app\api\model\Shop;class Test extends BaseController{    //  http://water.com/api/v1/test/token    // 获取微信服务器 access_token    public function getAccessToken(){        $token = (new AccessToken())->get();        halt($token);    }//  http://water.com/api/v1/test/shopers//  获取所有送货人信息    public function getShopers(){        $infos = Shoperinfo::all();        return $infos;    }    public function sendMsg(){				//$formid = input("post.formid");		//var_dump($formid);die;		//$formid = 'wx13174227679578a53ec128321053597516';		$openid = 'oyeOJ5Vu74NYXBcEsj9oJ-rXFlN0';		$formid ='wx142306174279090dbf1a6f991349532336';        //$openid = 'oyeOJ5S95SkN0UNMGFuGkzbZFeog';	// jian bo		//$openid = 'oyeOJ5R7k7S5ggYD2744pId01ffw';        $dmsg = new DeliveryMessage();        $dmsg->sendDeliveryMessage($formid,$openid);	//	return json(['code'=>200,'data'=>'ok']);    }    /**     *     shop_id 商家id    $sql = "SELECT shop_id,lat,lng,".get_distance_sql( $lat,$lng)." FROM table_name    WHERE distance< = ".$distance." ORDER BY distance ASC" ;     */// 附近商家 根据距离    public function getNearShops(){//        $User = $this->getUid();//        $User = User::get($User->user_id);//        if ($User->user_role==1 || $User->user_role ==4){//            $UserInfo = User::get($User->user_id)->getUserInfo;//            $lat = $UserInfo->latitude;//            $lng = $UserInfo->longitude;//            $distance = 1;//            /**//             * "round(6371*sqrt( pow((PI()*(abs(`lat`-23.403878))/180) * cos(PI()*(`lat`+23.403878)/360),2) \n   + pow((PI()*abs(`lng`-113.218853)/180),2)),4) as distance"//             */////            $sql = "SELECT shop_id,latitude,longitude,".get_distance_sql( $lat,$lng)." FROM sbw_shop WHERE distance < ".$distance." ORDER BY distance ASC" ;//            $sql = "SELECT t2.* FROM (SELECT *,".get_distance_sql( $lat,$lng)." FROM sbw_shop) t2 WHERE t2.distance < ".$distance." ORDER BY t2.distance ASC LIMIT 10" ;////            $sql = "SELECT *,".get_distance_sql( $lat,$lng)." FROM sbw_shop" ;//            $res = Db::query($sql);//            return $res;//        }else{//            echo 'hello';//        }//        $shop = array();//        halt($shop['hello']);//        $formid = $_POST['form_id'];//        halt($form_id);//        $formid ='wx20231247964409b368f5a0921387271186';//        $user_id = 73; //$order->user_id;     // 用户的user_id////        $m_user = User::getByUserID($user_id);//        $openid = 'oyeOJ5Vu74NYXBcEsj9oJ-rXFlN0';//$m_user->user_wxid;//'oyeOJ5S95SkN0UNMGFuGkzbZFeog';////        $msg = '你有新的订单';////        $shop_id = 23; //$order->shop_id;////        $shop_info = Shop::getByShopID($shop_id);////        $cost = $shop_info->service_fee;//        $dmsg = new ShoperMessage();//        $dmsg->sendShoperMessage($formid,$openid,'2017012012250',$cost,$msg);//        $lat = '23.402353';//        $lng = '100.239806';//        $lat =input('post.lat');// '23.402353';//        $lng = input('post.lng'); //'100.239806';//        halt($lat.'----'.$lng);//        $distance = 3;      // 距离 单位 1公里//        $rep_log = new ReportLog();//        $rep_data['latitude'] = $lat;//        $rep_data['longitude'] = $lng;//        $rep_data['createtime'] = time();//        $sql = "SELECT t2.* FROM (SELECT *,".get_distance_sql( $lat,$lng)." FROM sbw_shop) t2 WHERE t2.is_check=1 AND t2.distance < ".$distance." ORDER BY t2.distance ASC" ;//        try{//            $res = Db::query($sql);//            if (empty($res)){//                // 将处理信息返回给平台//                $same = $rep_log->findSame($lat,$lng);//                if (!$same){//                    $rep_log->save($rep_data);//                }//                return show(201,'附近没有商家，期待你的加入');//            }////            foreach ($res as $k =>$v){//                $res[$k]['shop_pic'] = config('setting.domain').$v['shop_pic'];//            }//        }catch (\Exception $e){//            return show(201,'附近暂无商家');//        }//        if (!$res){//            return show(201,'附近暂无商家');//        }//        return show(200,'获取成功',['res'=>$res]);        $User = $this->getUid();        $lat = User::get($User->user_id)->getUserInfo->latitude;        $lng = User::get($User->user_id)->getUserInfo->longitude;        $shop_data = Shop::getByShopID(4);        $shop_lat = $shop_data->latitude;        $shop_lng = $shop_data->longitude;        $res = GetDistanceNews($lat,$lng,$shop_lat,$shop_lng);        halt($res);    }    /*     * 给微信发送确认订单金额和签名正确，SUCCESS信息 -xzz0521     */    private function return_success(){        $return['return_code'] = 'SUCCESS';        $return['return_msg'] = 'OK';        $xml_post = '<xml>                    <return_code>'.$return['return_code'].'</return_code>                    <return_msg>'.$return['return_msg'].'</return_msg>                    </xml>';        echo $xml_post;exit;    }}