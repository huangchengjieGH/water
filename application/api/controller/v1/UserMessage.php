<?php/* * 获取用户信息 * 更新用户信息 * 删除用户信息 */namespace app\api\controller\v1;use app\api\controller\BaseController;use app\api\controller\WeiXinPay;use app\api\model\RefundOrder;use app\api\model\ShopEval;use app\api\model\User;use app\api\model\Shop;use app\api\model\Shoperinfo;//use app\api\model\Order;use app\api\model\Userinfo;//use app\api\model\SetMoney;//use app\api\service\FindRole;use app\api\validate\AddressNew;use app\api\validate\BusinessNew;use app\api\validate\UserInfoNew;use app\lib\exception\ParameterException;use app\api\service\Token;use think\Cache;use think\Loader;use think\Db;class UserMessage extends BaseController{    //用户信息    //获取验证    //获取地址    public function getAddresses()    {        // 获取用户信息        $User = $this->getUid();        // 获取用户地址        $address = User::get($User->user_id)->getUserInfo;        if ($address){            if (!$address->user_address){                return show(201,'暂无地址信息');            }        }        return show(200,'ok',['address'=>$address]);    }    //添加地址    //更新地址    public function createOrUpdateAddresses()    {        //验证传入值        $validate = new AddressNew();        $validate->goCheck();        $post = $validate->getDataByRule(input('post.'));        $address = $post['user_address'].''.trim($post['user_address_detail']);        $res =  \Tmap::getLngLat($address);//        $res = \Map::getLngLat($post['user_address']);        if($res){            //经度            $post['longitude'] =$res['result']['location']['lng'];            //纬度            $post['latitude'] =$res['result']['location']['lat'];        }        //return $post;        //获取用户信息        $data = $this->getUid();        $user = User::get($data->user_id);        $UserInfo = User::get($data->user_id)->getUserInfo;        if ($UserInfo) {            $user->getUserInfo->save($post);        } else {            $user->getUserInfo()->save($post);        }        return show(200,'成功');    }    //用户信息    public function createOrUpdateUserInfo()    {        //验证传入值        $validate = new UserInfoNew();        $validate->goCheck();        $post = $validate->getDataByRule(input('post.'));        $address = $post['user_address'].''.trim($post['user_address_detail']);        $res = \Tmap::getLngLat($address);       //关闭注册功能//        return show(1001,'该功能暂时不开发',$post);//        $res = \Map::getLngLat($post['user_address']);        if($res){            //经度            $post['longitude'] =$res['result']['location']['lng'];            //纬度            $post['latitude'] =$res['result']['location']['lat'];        }        //获取用户信息        $data = $this->getUid();        $user = User::get($data->user_id);        $UserInfo = User::get($data->user_id)->getUserInfo;        //押金        $fre = Model('SetMoney')->find()->toArray();        if($post['user_role']==1){            $fre = $fre['user_fre'];        }        if($post['user_role']==4){            $fre = $fre['company_fre'];            $post["is_business"] = 1;        }        $data['fre'] = $fre;        if ($UserInfo) {            $user->getUserInfo->save($post);            return show(200,'更新成功',$data);        } else {            $user->getUserInfo()->save($post);            return show(200,'创建成功',$data);        }    }    //判断是否交了押金    public function checkFRE()    {        // 获取用户信息        $User = $this->getUid();        $UserInfo = User::get($User->user_id)->getUserInfo;        if ($UserInfo->user_fre==1 && $UserInfo->is_business==0){            return show(200,'个人用户已交押金');        }else if($UserInfo->user_fre==0 && $UserInfo->is_business==0){            return show(201,'个人用户未交押金');        }else if($UserInfo->business_fre==1 && $UserInfo->is_business==1){            return show(200,'企业用户已交押金');        }else if($UserInfo->business_fre==0 && $UserInfo->is_business==1){            return show(201,'企业用户未交押金');        }else{            return show(201,'未交押金');        }    }    // 普通用户 评论    public function userComment(){        //@todo validate 验证层 添加 （未测试）        $data['user_id'] = Token::getCurrentUid();  // 当前用户的user_id        $data['shop_id'] = input("post.id");  // 商家ID        $data['eval'] = input("post.content");// 评论内容        $data['star'] = input("post.star");   // 评论等级        $shopEval = new ShopEval();        $res = $shopEval->add($data);        return $res;    }    //支付订单(交押金)    public function payOrder()    {        // 获取用户信息        $User = $this->getUid();        $user_role = input('post.user_role');        //return 12345;        // 是否普通用户//        if($User->user_role==3){//            return show(-200,'您没有权限！');//        }        //获取地址信息        $userInfo = User::get($User->user_id)->getUserInfo;        if(!$userInfo){            return show(-200,'请填写地址！');        }        //获取交押金情况        /*if ($userInfo->user_fre==1 && $userInfo->is_business==0) {            return show(200,'个人押金已交，企业押金未交！');        }        if ($userInfo->user_fre==1 && $userInfo->is_business==1) {            return show(201,'个人和企业押金已交！');        }        if ($userInfo->user_fre==0 && $userInfo->is_business==1) {            return show(202,'个人押金未交，企业押金已交！');        }        if ($userInfo->user_fre==0 && $userInfo->is_business==0) {            return show(203,'个人和企业押金未交！');        }*/        //确定信息        $openid = $User['user_wxid'];        //判断是否企业还是        $fre = Model('SetMoney')->find()->toArray();        if($user_role == 4){//企业            $body = '企业用户押金支付';            $total_fee = floatval( $fre['company_fre']*100);            $out_trade_no = 'b'.'_'.time().'_'.$User['user_id'];        }else{//普通            $body = '个人用户押金支付';            $total_fee = floatval( $fre['user_fre']*100);            $out_trade_no = 'p'.'_'.time().'_'.$User['user_id'];        }        //配置信息        //$notify_url = config('paySet.notify_url');        $notify_url = config('setting.domain').'/api/v1/user/payOrderNotify';        $app_id = config('paySet.app_id');        $mch_id = config('paySet.mch_id');        $key = config('paySet.key');        //生成签名，返回给小程序        $pay = new WeiXinPay($app_id, $openid, $mch_id, $key, $out_trade_no, $body, $total_fee,$notify_url);        $return = $pay->pay();        // die($return);        return $return;    }    //支付异步,回调地址    public function payOrderNotify()    {        $postXml = file_get_contents("php://input");        if (empty($postXml)) {            return false;        }        //获取回调参数更新数据        $result = $this->xmlToArray($postXml);        if ($result['return_code'] == 'FAIL') {            return false;        }        if ($result['result_code'] == 'FAIL') {            return false;        }        if($result["return_code"] != "SUCCESS" ){            return false;         }        //获取订单号        $outTradeNo = $result['out_trade_no'];        $price =floatval( $result['total_fee']*0.01);        $array = explode('_',$outTradeNo);        //从订单号中提取id        $user_id = $array[2];        $type = $array[0];        $user = User::get($user_id);        $UserInfo = User::get($user_id)->getUserInfo;        $user->save(['user_role' => 1]);        // 更新角色        //判断更新数据库        if (!$UserInfo) {            return false;        }else{            $dep_order = new RefundOrder();//            $dep_data = [];            //判断是否企业还是            $fre = Db::table('sbw_set_money')->find();            $company_fre = $fre['company_fre'];            if($price == $company_fre && $type=='b' && $UserInfo->business_fre==0){//企业                if($user->user_role==0) {                    $user->getUserInfo->save(['business_fre' => 1, 'is_business' => 1]);                }else{                    $user->getUserInfo->save(['business_fre' => 1]);                }                $dep_data['type'] = 2 ;                $dep_data['order_id'] = $outTradeNo;                $dep_data['user_id'] = $user_id;                $dep_data['price'] = $price;                $dep_data['o_builddate']=time();                $dep_order->save($dep_data);                return $this->return_success();            }else if($type=='p' && $UserInfo->user_fre==0){//普通                $user->getUserInfo->save(['user_fre' => 1]);                $dep_data['type'] = 1 ;                $dep_data['order_id'] = $outTradeNo;                $dep_data['user_id'] = $user_id;                $dep_data['price'] = $price;                $dep_data['o_builddate']=time();                $dep_order->save($dep_data);                return $this->return_success();            }        }        return false;    }    //给微信发送确认订单金额和签名正确，SUCCESS信息 -xzz0521    private function return_success(){        $return['return_code'] = 'SUCCESS';        $return['return_msg'] = 'OK';        $xml_post = '<xml>                    <return_code>'.$return['return_code'].'</return_code>                    <return_msg>'.$return['return_msg'].'</return_msg>                    </xml>';        return  $xml_post;    }    //将xml格式转换成数组    private function xmlToArray($xml)    {        //禁止引用外部xml实体        libxml_disable_entity_loader(true);        $xmlstring = simplexml_load_string($xml, 'SimpleXMLElement', LIBXML_NOCDATA);        $val = json_decode(json_encode($xmlstring), true);        return $val;    }    //获取手机号    public function getPhone(){        $data=file_get_contents("php://input");        $array = json_decode($data,true);       // var_dump($array);die;        $token = $array["token"];		$encryptedData = $array["encryptedData"];        $iv = $array["iv"];		$appid = config('paySet.app_id');        //$token = '353114f984a5177a5e3065ed4acdb297';        $cache = Cache::get($token);       // var_dump($cache);die;        $cache = json_decode($cache,true);        $session_key = $cache['session_key'];        //$encryptedData="jIOJO2LC8KdR4tE8ahvqWNRszgLbbzqRpjDs3GXIQJRiGv+QxuMHhqUM5OzT5CQW4PjREJq2wvc7Hsp+aQ9qzpWb6DZdyAxTvlUdvbSRMCD4/RkMpLAWe0w2eDxTG3TlBeT7oLgPtLx1a1RDgijALYROE2HyaMiMapB8k99uriZTJxgz4AnITYYgMj/5hkg4M0w76+npAq04uB4fhwN/bTgmBn0k0cxB1wnW6JVJQjwc0q1nxckfwmx24nvO7JeB8LnzOF5SPk895H14ArbQcnYipimGkXLacKrAqUxU7LIQRgguU2ay6rpuVjKVXQmCiYIRSkMEkqghyPm/PPYC1lRDeTK5w+gI5BgoajQt9rp/RBbWwMF1Y9aoGrcCuE9AVdnR51wkHso6InlcyG6xzxk3bUcXFd0foh4EAp2dbvQb+YcogPgM/koS9gEhUSczC2kCNSuP2d/KgGmAApjY4fxDm7F42nPQr7F4z4DCtuE=";        //$iv = '0csFWV8SSGz1G8KadGyN7A==';        Loader::import('wechat.wxBizDataCrypt');        $pc = new \WXBizDataCrypt($appid,$session_key);        $errCode = $pc->decryptData($encryptedData, $iv,$data);		$rest = json_decode($data,true);		//halt($rest);		// 获取用户信息        $User = $this->getUid();		Db::table('sbw_userinfo')->where('user_id',$User->user_id)->update(['user_phone'=>$rest['phoneNumber']]);        if ($errCode == 0) {            print($data . "\n");        } else {            print($errCode . "\n");        }    }    //判断角色    public function checkUserRole()    {        // 获取用户信息        $User = $this->getUid();        //$role = 1;        // 获取用户地址        $UserInfo = User::get($User->user_id)->getUserInfo;        if ($UserInfo) {            if ($User->user_role==1 && $UserInfo->is_business==1) {               $role = 4;            }else{                $role = $User->user_role;            }                   }else{            $role = $User->user_role;        }        $data['role'] = $role;        return ["code"=>200,"msg"=>"角色判断","data"=>$data];        //return show(200,'角色判断',$data['role']);    }    //切换角色    public function changeUserRole()    {        // 需切换的角色//        $role =  $role;        // 获取用户信息        $User = $this->getUid();        $role = input('post.role');        $User = User::get($User->user_id);        $UserInfo = User::get($User->user_id)->getUserInfo;        $Shoperinfo = Shoperinfo::getByUserID($User->user_id);        if(!in_array($role,array(1,2,3,4))){            return show(201,'角色传参错误！');        }        // 切换        switch ($role){            //普通用户            case 1://                return $User->getUserInfo->is_business;                if($User->user_role == 1  && $User->getUserInfo->is_business==0 ){                    return show(201,'已是个人用户，不用切换！');                }else if($UserInfo->user_fre ==0 ){                    return show(201,'你不是个人会员，是否去注册！');                }else{                    $User->user_role=1;                    $User->save();                    $UserInfo = new Userinfo;                    $UserInfo->save(['is_business'  => 0],['user_id' => $User->user_id]);                    //$User->getUserInfo->is_business = 0;                    return show(200,'已切换为个人用户！');                }                break;            //水店骑手            case 2:                if($User->user_role == 2){                    return show(201,'已是水店骑手，不用切换！');                }                if(!$Shoperinfo){                    return show(201,'你不是商家骑手');                }                else{                    $User->user_role=2;                    $User->save();                    return show(200,'已切换为水店骑手！');                }                break;            //水店商家            case 3:                if($User->user_role == 3){                    return show(201,'已是水店商家，不用切换！');                }                $shop_info = Shop::getByUserID($User->user_id);                if (!$shop_info){                    return show(201,'你不是商家，是否去注册！');                }                if($shop_info->is_check==1 && $shop_info->is_pay==1){                    $User->user_role = 3;                    $User->save();                    return show(200,'已切换为水店商家！');                }                if($shop_info->is_check==0 && $shop_info->is_pay==1){                    $User->user_role = 3;                    $User->save();                    return show(200,'已切换为水店商家！');                    // return show(201,'请等待审核通过！');                }else{                    return show(201,'请交押金！');                }                break;            //企业用户            case 4:                //$User = User::get($User->user_id);                if($User->user_role == 1 && $User->getUserInfo->is_business==1){                    return show(201,'已是企业用户，不用切换！');                }                if($UserInfo->business_fre==0){                    return show(201,'你不是企业，是否去注册！');                }else{                    $User->user_role=1;                    //$User->getUserInfo->is_business = 1;                    $User->save();                    $UserInfo = new Userinfo;                    $UserInfo->save(['is_business'  => 1],['user_id' => $User->user_id]);                    return show(200,'已切换为企业用户！');                }                break;            default:                return show(201,'传入切换角色不存在！');                break;        }    }    //检查用户信息    public function checkUserMessage()    {        // 获取用户        $UserMessage = $this->getUid();        // 个人和企业用户        if($UserMessage->user_role==1){//判断是否交押金            return $this->checkFRE();        }else if($UserMessage->user_role==2){//判断是否骑手            $Shoperinfo = Shoperinfo::getByUserID($UserMessage->user_id);            if($Shoperinfo){                return show(400,'骑手');            }else{                return show(-400,'不是骑手');            }        }else if($UserMessage->user_role==3){//判断商家            $Shop = Shop::getByUserID($UserMessage->user_id);            if($Shop){                if($Shop->is_pay==1){                    return show(800,'水店已交押金');                }else{                    return show(801,'水店未交押金');                }            }else{                return show(-800,'无水店');            }        }else{//default            return show(-900,'未授权角色！');        }    }    //............	public function identify(){		//验证传入值        $validate = new BusinessNew();        $validate->goCheck();        $post = $validate->getDataByRule(input('post.'));         // 获取用户信息        $User = $this->getUid();        //return 12345;        // 是否普通用户        if($User->user_role!=1){            throw new ParameterException([                'msg' => '没有权限！'            ]);        }        //获取交押金情况        $userInfo = User::get($User->user_id)->getUserInfo;        if(!$userInfo){            throw new ParameterException([                'msg' => '该用户不存在！'            ]);        }        if ($userInfo->is_business==1) {            throw new ParameterException([                'msg' => '您已经是企业用户，无需再审核！'            ]);        }        $m_userid = $userInfo->user_id;        $post['is_business'] = 1;        unset($post['token']);        (new Userinfo())->save($post,['user_id'=>$m_userid]);        return ["code"=>200,"msg"=>"成功"];	}	//获取用户审核和押金状况    public function getExamineAndFre()    {        $user_role = input('post.user_role');        $post = array(0,1,2,3,4);        if(!in_array($user_role,$post)){            return show(-200,'角色传参错误！');        }        $User = $this->getUid();        $UserInfo = User::get($User->user_id)->getUserInfo;        $fre = Model('SetMoney')->field('user_fre,shop_fre,company_fre')->find()->toArray();        $shop = Db::table("sbw_shop")->where('user_id', $User->user_id)->find();        $data = array();//        halt($shop);        if($UserInfo->user_address_detail!=''){            $data['userAndcompany'] = 1;//提交过用户端资料        }else{            $data['userAndcompany'] = 0;//未提交用户端资料        }        if($shop!=''){            $data['shop'] = 1;//提交过商家资料            $data['shop_fre_status'] = $shop['is_pay'];//商家是否交押金            $data['shop_check_status'] = $shop['is_check'];//商家是否通过审核        }else{            $data['shop'] = 0;            $data['shop_fre_status'] = 0;            $data['shop_check_status'] = 0;        }        $data['user_fre_status'] = $UserInfo->user_fre;//个人用户是否交押金        $data['company_fre_status'] = $UserInfo->business_fre;//企业用户是否交押金        $data['isCollected'] = $User->u_isvip;        $data['fre'] = $fre;        return show(200,'角色详细信息',$data);        /*$user_role = input('post.user_role');        $post = array(0,1,2,3,4);        if(!in_array($user_role,$post)){            return show(-200,'角色传参错误！');        }        $User = $this->getUid();        $UserInfo = User::get($User->user_id)->getUserInfo;        $fre = Model('SetMoney')->field('user_fre,shop_fre,company_fre')->find()->toArray();        $shop = Db::table("sbw_shop")->where('user_id', $User->user_id)->find();        $data = array();        //骑手        if ($user_role == 2){            return show(200,'骑手',$fre);        }        //新用户        if ($user_role == 0){            if($shop!='' && $UserInfo->user_address_detail!=''){                return show(200,'新用户已提交商家资料和个人资料',$fre);            }else if($shop!='' && $UserInfo->user_address_detail == ''){                return show(201,'新用户已提交商家资料，未提交个人资料',$fre);            }else if($shop =='' && $UserInfo->user_address_detail != ''){                return show(202,'新用户已提交个人资料，未提交商家资料',$fre);            }else if($shop =='' && $UserInfo->user_address_detail == ''){                return show(203,'新用户未提交任何资料',$fre);            }        }        //个人用户        if ($user_role == 1) {            if ($UserInfo->user_fre == 1) {                $data['user_fre'] = $fre['user_fre'];                return show(200,'个人用户已交押金',$fre);            } else if($UserInfo->user_fre == 0 && $UserInfo->user_address_detail!=''){                return show(201,'个人用户已提交资料，未交押金',$fre);            }else{                return show(202,'个人用户未提交资料',$fre);            }        }        //企业        if ($user_role == 4) {            if ($UserInfo->business_fre == 1) {                $data['company_fre'] = $fre['company_fre'];                return show(200,'企业已交押金',$fre);            } else if($UserInfo->is_business == 1 && $UserInfo->business_fre == 0 && $UserInfo->user_address_detail!=''){                return show(201,'企业已提交资料，未交押金',$fre);            }else{                return show(202,'企业未提交资料',$fre);            }        }        //商家        if ($user_role == 3) {            if ($shop['is_pay'] == 1) {                $data['shop_fre'] = $fre['shop_fre'];                return show(200,'商家已交押金',$fre);            } else if($shop!='' && $shop['is_pay'] == 0){                return show(201,'商家已提交资料，未交押金',$fre);            }else{                return show(202,'商家未提交资料',$fre);            }        }*/    }    //获取当前用户押金订单    public function getFreNow()    {        $User = $this->getUid();        $user_role = input('post.user_role');        $post = array(1,3,4);//1个人,4企业,3商家        if(!in_array($user_role,$post)){            return show(201,'该用户暂无交押金');        }        if ($user_role==4){            $user_role=2;        }        $fre_now = RefundOrder::getByUserID($User->user_id,$user_role);        if(!$fre_now){            return show(201,'该用户暂无交押金');        }            return show(200,'押金获取成功',['fre_now'=>$fre_now]);    }    //获取地址    public function getLocation($lng,$lat)    {        $key = config('tmap.key');        $location =file_get_contents('https://apis.map.qq.com/ws/geocoder/v1/?location='.$lat.','.$lng.'&key='.$key.'&get_poi=1');        echo $location;    }}